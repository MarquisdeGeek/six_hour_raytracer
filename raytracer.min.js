let vec3=window.sgxVector3f,point3=window.sgxVector3f,color3=window.sgxVector3f;window.sgxPoint3f.randomUnitDisk=function(){for(;;){var e=sgxPoint3f.random(-1,1),t=(e.z=0,e.getMagnitudeSquared());if(t<=1)return e}},window.sgxPoint3f.randomUnitOnHemisphere=function(e){var t=window.sgxPoint3f.randomUnit();return 0<t.dot(e)||t.neg(),t},window.sgxPoint3f.prototype.nearZero=function(){return sgxEq(this.x,0)&&sgxEq(this.y,0)&&sgxEq(this.z,0)},window.sgxPoint3f.reflect=function(e,t){var a=new vec3(e),e=2*e.dot(t),t=new vec3(t);return t.mul(e),a.sub(t),a},window.sgxVector3f.refract=function(e,t,a){var i=new vec3(e),i=(i.neg(),sgxMin(i.dot(t),1)),r=new vec3(t),i=(r.mul(i),r.add(e),r.mul(a),new vec3(t)),e=-sgxSqr(sgxAbs(1-r.getMagnitudeSquared()));return i.mul(e),r.add(i),r},vec3.saveData=function(e){return e.x+` ${e.y} `+e.z},color3.saveData=function(e){return`${sgxRoundDown(255.999*e.x)} ${sgxRoundDown(255.999*e.y)} `+sgxRoundDown(255.999*e.z)};class PPM{constructor(e,t){this.width=e,this.height=t,this.bpp=3,this.data=new Uint8Array(e*t*this.bpp)}setPixel(e,t,a,i,r){e=(e+t*this.width)*this.bpp;this.data[0+e]=a,this.data[1+e]=i,this.data[2+e]=r}saveData(){let a="";a=(a+=`P3
`)+this.width+` ${this.height}
`+`255
`;for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++){var i=(e+t*this.width)*this.bpp,i=new color3(this.data[0+i]/255,this.data[1+i]/255,this.data[2+i]/255);a+=color3.saveData(i)+` 
`}return a}}function create(e,t){return new PPM(e,t)}var ppm=Object.freeze({__proto__:null,create:create});function surfaceToPPM(e){var a=new sgx.ImageData,i=(e.lock(a),a.getWidth()),r=a.getHeight(),s=raytracer.ppm.create(i,r),n=new sgxColorRGBA;for(let t=0;t<r;t++)for(let e=0;e<i;e++)a.getPixelAt(n,e,t),s.setPixel(e,t,255*n.r,255*n.g,255*n.b);return e.unlock(a),s}class interval{constructor(e=SGX_INF,t=-SGX_INF){this.min_=e,this.max_=t}min(){return this.min_}max(){return this.max_}size(){return this.max_-this.min_}contains(e){return this.min_<=e&&e<=this.max_}surrounds(e){return this.min_<e&&e<this.max_}clamp(e){return e<this.min_?this.min_:e>this.max_?this.max_:e}}let intervalEmpty=new interval(+SGX_INF,-SGX_INF),intervalUniverse=new interval(-SGX_INF,+SGX_INF);function linear_to_gamma(e){return 0<e?sgxSqr(e):0}var utils=Object.freeze({__proto__:null,interval:interval,intervalEmpty:intervalEmpty,intervalUniverse:intervalUniverse,linear_to_gamma:linear_to_gamma,surfaceToPPM:surfaceToPPM});class HitRecord{static#hrCache;static#hrCacheIndex;static#hrCacheSize=128;static{HitRecord.#hrCache=new Array(HitRecord.#hrCacheSize);for(let e=0;e<HitRecord.#hrCacheSize;++e)HitRecord.#hrCache[e]=new HitRecord;HitRecord.#hrCacheIndex=0}constructor(e,t,a,i){this.point_=new point3(e),this.normal_=new vec3(t),this.t_=a,this.front_face_=void 0,this.material=i}static startRay(){HitRecord.#hrCacheIndex=0}static create(e,t,a,i){var r;return HitRecord.#hrCacheIndex>=HitRecord.#hrCacheSize?new HitRecord(e,t,a,i):((r=HitRecord.#hrCache[HitRecord.#hrCacheIndex++]).point_.set(e),r.normal_.set(t),r.t_=a,r.material=i,r)}point(){return this.point_}normal(){return this.normal_}t(){return this.t_}front_face(){return this.front_face_}set_face_normal(e,t){this.front_face_=e.direction().dot(t)<0,this.normal_.set(t),this.front_face_||this.normal_.neg()}}class Hittable{constructor(){}hit(e,t,a){return!1}hitInterval(e,t){return!1}}class HittableList{constructor(){this.clear()}clear(){this.list_=[]}add(e){this.list_.push(e)}hit(t,a,e){let i=e,r=null;return this.list_.forEach(e=>{e=e.hit(t,a,i);e&&(i=e.t(),r=e)}),r}hitInterval(t,a){let i=a.max(),r=null;return this.list_.forEach(e=>{e=e.hit(t,a.min(),i);e&&(i=e.t(),r=e)}),r}}var hittable=Object.freeze({__proto__:null,HitRecord:HitRecord,Hittable:Hittable,HittableList:HittableList});class Sphere extends Hittable{constructor(e,t,a){super(),this.center_=new vec3(e),this.radius_=t,this.material=a,this.oc=new vec3,this.normal=new vec3}hitInterval(e,t){return this.hit(e.the_ray_interval.min(),t.max())}hit(e,t,a){var i=this.oc,r=(i.set(this.center_),i.sub(e.origin()),e.direction().getMagnitudeSquared()),s=e.direction().dot(i),i=s*s-r*(i.getMagnitudeSquared()-this.radius_*this.radius_);if(i<0)return null;i=sgxSqr(i);let n=(s-i)/r;return(n<=t||a<=n)&&((n=(s+i)/r)<=t||a<=n)?null:(s=e.at(n),(i=this.normal).set(s),i.sub(this.center_),i.div(this.radius_),(r=HitRecord.create(s,i,n,this.material)).set_face_normal(e,i),r)}}class Material{constructor(){}scatter(e,t,a){return null}}class ray{constructor(e,t){this.origin_=new vec3(e),this.direction_=new vec3(t)}direction(){return this.direction_}origin(){return this.origin_}at(e){var t=new vec3(this.direction_);return t.mul(e),t.add(this.origin_),t}}class Metal extends Material{#albedo;#fuzz;constructor(e,t){super(),this.#albedo=e,this.#fuzz=t}scatter(e,t){var e=sgxPoint3f.reflect(e.direction(),t.normal()),a=(e.normalize(),sgxPoint3f.randomUnit()),a=(a.mul(this.#fuzz),e.add(a),new ray(t.point(),e));return{scattered:a,attenuation:this.#albedo}}}class Lambertian extends Material{#albedo;constructor(e){super(),this.#albedo=e}scatter(e,t){let a=sgxPoint3f.randomUnit();return a.add(t.normal()),a.nearZero()&&(a=t.normal()),{scattered:new ray(t.point(),a),attenuation:this.#albedo}}}class Dielectric extends Material{#refraction_index;static#white=new vec3(1,1,1);constructor(e){super(),this.#refraction_index=e}#reflectance(e,t){t=(1-t)/(1+t);return(t*=t)+(1-t)*sgxPower(1-e,5)}scatter(e,t){var a=t.front_face()?1/this.#refraction_index:this.#refraction_index,e=new vec3(e.direction()),i=(e.normalize(),e.neg(),sgxMin(t.normal().dot(e),1)),r=1<a*sgxSqr(1-i*i);let s;e.neg();s=r||this.#reflectance(i,a)>sgxRand()?sgxPoint3f.reflect(e,t.normal()):sgxVector3f.refract(e,t.normal(),a),r=new ray(t.point(),s);return{scattered:r,attenuation:Dielectric.#white}}}var materials=Object.freeze({__proto__:null,Dielectric:Dielectric,Lambertian:Lambertian,Metal:Metal});let fps=30;function start(){return{supported:window.onRenderProgress,durationLastFrame:0,durationLastFrameWallClock:0,maxFrameDuration:sgxRoundDown(1e3/fps),startTime:performance.now(),startFrameAt:void 0,userdata:void 0}}function startFrame(e){e.startFrameAt=performance.now()}function yieldFrame(e){var t=performance.now()-e.startFrameAt;return e.maxFrameDuration<t&&(e.durationLastFrame+=t,!0)}function update(e,t){var a,i;return!e.supported||(a=1===t,t=sgxFloor(100*t),i=e.durationLastFrame,e=performance.now()-e.startTime,window.onRenderProgress({percentage:t,duration:i,durationWallClock:e,complete:a}))}function endFrame(e){var t=performance.now()-e.startFrameAt;e.durationLastFrame+=t}function end(e){update(e,1)}function createCanvasPattern(e){var t=start(),a=new sgx.ImageData,i=(e.lock(a),startFrame(t),a.getWidth()),r=a.getHeight();for(let t=0;t<r;t++)for(let e=0;e<i;e++){var s=e/(i-1),n=t/(r-1);a.setPixelAt({r:s,g:n,b:0,a:1},e,t)}endFrame(t),e.unlock(a),end(t)}var s02=Object.freeze({__proto__:null,createCanvasPattern:createCanvasPattern});let cacheUnitDirection=new vec3,cacheCol1=new color3,cacheCol2=new color3;function rcGradient(e){cacheUnitDirection.set(e.direction()),cacheUnitDirection.normalize();e=.5*(cacheUnitDirection.y+1);return cacheCol2.set(.5,.7,1),cacheCol2.mul(e),e=1-e,cacheCol1.x=cacheCol1.y=cacheCol1.z=e,cacheCol2.x+=cacheCol1.x,cacheCol2.y+=cacheCol1.y,cacheCol2.z+=cacheCol1.z,cacheCol2}function rcBlack(e){return new color3(0,0,0)}function raytrace(e,a){var t=start(),i=new sgx.ImageData,r=(e.lock(i),startFrame(t),e.getWidth()),s=e.getHeight(),n=new point3(0,0,0),c=r/s*2,c=new vec3(c,0,0),h=new vec3(0,-2,0),o=new vec3(c),l=(o.div(r),new vec3(h)),d=(l.div(s),new vec3(0,0,1)),c=new vec3(c),h=(c.div(2),new vec3(h)),_=(h.div(2),new vec3(n)),d=(_.sub(d),_.sub(c),_.sub(h),new vec3(o)),u=(d.add(l),d.mul(.5),new vec3(_));u.add(d);for(let t=0;t<s;t++)for(let e=0;e<r;e++){var m=new vec3(u),g=new vec3(o),p=(g.mul(e),new vec3(l)),g=(p.mul(t),m.add(g),m.add(p),new vec3(m)),p=(g.sub(n),new ray(n,g)),m=a(p);i.setPixelAt({r:m.x,g:m.y,b:m.z,a:1},e,t)}endFrame(t),e.unlock(i),end(t)}var s04=Object.freeze({__proto__:null,raytrace:raytrace,rcBlack:rcBlack,rcGradient:rcGradient});function hit_sphere$1(e,t,a){var e=new vec3(e),i=(e.sub(a.origin()),a.direction().dot(a.direction())),a=-2*a.direction().dot(e);return 0<=a*a-4*i*(e.dot(e)-t*t)}function rcBasicSphere(e){return hit_sphere$1(new point3(0,0,-1),.5,e)?new color3(1,0,0):rcGradient(e)}var s05=Object.freeze({__proto__:null,rcBasicSphere:rcBasicSphere});let unitZNegative=new sgxVector3f(0,0,-1);function hit_sphere(e,t,a){var e=new vec3(e),i=(e.sub(a.origin()),a.direction().dot(a.direction())),a=-2*a.direction().dot(e),e=a*a-4*i*(e.dot(e)-t*t);return e<0?-1:(-a-sgxSqr(e))/(2*i)}function hit_sphere_simple(e,t,a){var e=new vec3(e),i=(e.sub(a.origin()),a.direction(),a.direction().getMagnitudeSquared()),a=a.direction().dot(e),e=a*a-i*(e.getMagnitudeSquared()-t*t);return e<0?-1:(a-sgxSqr(e))/i}function rcShadedSphereBasic(e,t){var t=t(new point3(0,0,-1),.5,e);return 0<t?((t=new vec3(e.at(t))).sub(unitZNegative),t.normalize(),(t=new color3(t.x+1,t.y+1,t.z+1)).mul(.5),t):rcGradient(e)}function rcShadedSphere(e){return rcShadedSphereBasic(e,hit_sphere)}function rcShadedSphereSimplifiedHitTest(e){return rcShadedSphereBasic(e,hit_sphere_simple)}function rcShadedSphereWithSurfaceObject(e){var t=new Sphere(unitZNegative,.5).hit(e,0,1);return t?(t=t.normal(),(t=new color3(t.x+1,t.y+1,t.z+1)).mul(.5),t):rcGradient(e)}function rcShadedWorld(e){var t=new interval(0,SGX_INF),t=this.world.hitInterval(e,t);return t?(t=t.normal(),(t=new color3(t.x+1,t.y+1,t.z+1)).mul(.5),t):rcGradient(e)}var s06=Object.freeze({__proto__:null,rcShadedSphere:rcShadedSphere,rcShadedSphereSimplifiedHitTest:rcShadedSphereSimplifiedHitTest,rcShadedSphereWithSurfaceObject:rcShadedSphereWithSurfaceObject,rcShadedWorld:rcShadedWorld});let Camera$3=class{#surface;constructor(e){this.#surface=e,this.image_width=e.getWidth(),this.image_height=e.getHeight(),this.aspect_ratio=this.image_width/this.image_height,this.initialise()}initialise(){this.camera_center=new point3(0,0,0);var e=this.image_width/this.image_height*2,e=new vec3(e,0,0),t=new vec3(0,-2,0),a=(this.pixel_delta_u=new vec3(e),this.pixel_delta_u.div(this.image_width),this.pixel_delta_v=new vec3(t),this.pixel_delta_v.div(this.image_height),new vec3(0,0,1)),e=new vec3(e),t=(e.div(2),new vec3(t)),i=(t.div(2),new vec3(this.camera_center)),a=(i.sub(a),i.sub(e),i.sub(t),new vec3(this.pixel_delta_u));a.add(this.pixel_delta_v),a.mul(.5),this.pixel00_loc=new vec3(i),this.pixel00_loc.add(a)}render(a){var e=start(),i=new sgx.ImageData;this.#surface.lock(i),startFrame(e);for(let t=0;t<this.image_height;t++)for(let e=0;e<this.image_width;e++){var r=new vec3(this.pixel00_loc),s=new vec3(this.pixel_delta_u),n=(s.mul(e),new vec3(this.pixel_delta_v)),s=(n.mul(t),r.add(s),r.add(n),new vec3(r)),n=(s.sub(this.camera_center),new ray(this.camera_center,s)),r=this.#rcShadedWorld(n,a);i.setPixelAt({r:r.x,g:r.y,b:r.z,a:1},e,t)}endFrame(e),this.#surface.unlock(i),end(e)}#rcShadedWorld(e,t){var a=new interval(0,SGX_INF),t=t.hitInterval(e,a);return t?(a=t.normal(),(t=new color3(a.x+1,a.y+1,a.z+1)).mul(.5),t):rcGradient(e)}};var s07=Object.freeze({__proto__:null,Camera:Camera$3});let CameraSettings$2=class CameraSettings{static#_SCATTER_OFF=0;static#_SCATTER_LINEAR=1;static#_SCATTER_LAMBERTIAN=2;constructor(){this.scatteringAlgorithm=CameraSettings.#_SCATTER_OFF,this.scatteringMaxDepth=10,this.fixShadowAcne=!1,this.applyGammaCorrection=!1,this.realtimeUpdate=!0}static get SCATTER_OFF(){return CameraSettings.#_SCATTER_OFF}static get SCATTER_LINEAR(){return CameraSettings.#_SCATTER_LINEAR}static get SCATTER_LAMBERTIAN(){return CameraSettings.#_SCATTER_LAMBERTIAN}},Camera$2=class{#surface;#image_width;#image_height;#aspect_ratio;#samples_per_pixel;#pixel_samples_scale;#maxBounceDepth=2;constructor(e){this.#surface=e,this.#image_width=e.getWidth(),this.#image_height=e.getHeight(),this.#aspect_ratio=this.#image_width/this.#image_height,this.initialise()}initialise(){this.camera_center=new point3(0,0,0);var e=this.#image_width/this.#image_height*2,e=new vec3(e,0,0),t=new vec3(0,-2,0),a=(this.pixel_delta_u=new vec3(e),this.pixel_delta_u.div(this.#image_width),this.pixel_delta_v=new vec3(t),this.pixel_delta_v.div(this.#image_height),new vec3(0,0,1)),e=new vec3(e),t=(e.div(2),new vec3(t)),i=(t.div(2),new vec3(this.camera_center)),a=(i.sub(a),i.sub(e),i.sub(t),new vec3(this.pixel_delta_u));a.add(this.pixel_delta_v),a.mul(.5),this.pixel00_loc=new vec3(i),this.pixel00_loc.add(a),this.setSamplesPerPixel(10),this.settings=new CameraSettings$2}setSamplesPerPixel(e){this.#samples_per_pixel=e,this.#pixel_samples_scale=1/e}getSamplesPerPixel(){return this.#samples_per_pixel}render(e){var t=start(),a=new sgx.ImageData;this.#surface.lock(a),t.userdata={row:0,surface:this.#surface,imageData:a},this.renderNext(e,t)}renderNext(a,e){for(startFrame(e);e.userdata.row<this.#image_height;){var i=e.userdata.row;for(let t=0;t<this.#image_width;t++){HitRecord.startRay();var r=new color3(0,0,0);for(let e=0;e<this.#samples_per_pixel;e++){var s=this.#get_ray(t,i);r.add(this.#rcShadedWorld(s,this.#maxBounceDepth,a))}r.mul(this.#pixel_samples_scale),e.userdata.imageData.setPixelAt({r:r.x,g:r.y,b:r.z,a:1},t,i)}if(++e.userdata.row,yieldFrame(e)){if(update(e,e.userdata.row/this.#image_height))return this.settings.realtimeUpdate&&e.userdata.surface.unlock(e.userdata.imageData),void setTimeout(()=>{this.renderNext(a,e)},0);break}}endFrame(e),e.userdata.surface.unlock(e.userdata.imageData),end(e)}#get_ray(e,t){var a=this.#sample_square(),i=new vec3(this.pixel00_loc),r=new vec3(this.pixel_delta_u),e=(r.mul(e+a.x),new vec3(this.pixel_delta_v)),t=(e.mul(t+a.y),i.add(r),i.add(e),new vec3(i)),a=this.camera_center;return t.sub(a),new ray(a,t)}#sample_square(){return new vec3(sgxRand()-.5,sgxRand()-.5,0)}#rcShadedWorld(e,t,a){if(t<0)return new color3(0,0,0);var i=this.settings.fixShadowAcne?.001:0,i=new interval(i,SGX_INF),r=a.hitInterval(e,i);if(r){var s=r.normal();let e;switch(this.settings.scatteringAlgorithm){case CameraSettings$2.SCATTER_OFF:(e=new color3(s.x+1,s.y+1,s.z+1)).mul(.5);break;case CameraSettings$2.SCATTER_LINEAR:var n=sgxPoint3f.randomUnitOnHemisphere(s),n=new ray(r.point(),n);(e=this.#rcShadedWorld(n,t-1,a)).mul(.5);break;case CameraSettings$2.SCATTER_LAMBERTIAN:n=sgxPoint3f.randomUnit(),n=(n.add(s),new ray(r.point(),n));(e=this.#rcShadedWorld(n,t-1,a)).mul(.5)}return this.settings.applyGammaCorrection&&(e.x=linear_to_gamma(e.x),e.y=linear_to_gamma(e.y),e.z=linear_to_gamma(e.z)),e}return rcGradient(e)}};var s08=Object.freeze({__proto__:null,Camera:Camera$2,CameraSettings:CameraSettings$2});let kBlack$1=new color3(0,0,0),CameraSettings$1=class{constructor(){this.scatteringMaxDepth=10,this.fixShadowAcne=!0,this.applyGammaCorrection=!0,this.realtimeUpdate=!0}},Camera$1=class{#surface;#image_width;#image_height;#aspect_ratio;#samples_per_pixel;#pixel_samples_scale;constructor(e){this.#surface=e,this.#image_width=e.getWidth(),this.#image_height=e.getHeight(),this.#aspect_ratio=this.#image_width/this.#image_height,this.initialise()}initialise(){this.fov=90,this.camera_center=new point3(0,0,0);var e=this.fov*SGX_PI/180,e=2*sgxTan(e/2)*1,t=e*(this.#image_width/this.#image_height),t=new vec3(t,0,0),e=new vec3(0,-e,0),a=(this.pixel_delta_u=new vec3(t),this.pixel_delta_u.div(this.#image_width),this.pixel_delta_v=new vec3(e),this.pixel_delta_v.div(this.#image_height),new vec3(0,0,1)),t=new vec3(t),e=(t.div(2),new vec3(e)),i=(e.div(2),new vec3(this.camera_center)),a=(i.sub(a),i.sub(t),i.sub(e),new vec3(this.pixel_delta_u));a.add(this.pixel_delta_v),a.mul(.5),this.pixel00_loc=new vec3(i),this.pixel00_loc.add(a),this.setSamplesPerPixel(10),this.settings=new CameraSettings$1}setSamplesPerPixel(e){this.#samples_per_pixel=e,this.#pixel_samples_scale=1/e}getSamplesPerPixel(){return this.#samples_per_pixel}render(e){var t=start(),a=new sgx.ImageData;this.#surface.lock(a),t.userdata={row:0,surface:this.#surface,imageData:a},this.renderNext(e,t)}renderNext(a,e){for(startFrame(e);e.userdata.row<this.#image_height;){var i=e.userdata.row;for(let t=0;t<this.#image_width;t++){HitRecord.startRay();var r=new color3(0,0,0);for(let e=0;e<this.#samples_per_pixel;e++){var s=this.#get_ray(t,i);r.add(this.#rcShadedWorld(s,this.settings.scatteringMaxDepth,a))}r.mul(this.#pixel_samples_scale),this.settings.applyGammaCorrection&&(r.x=linear_to_gamma(r.x),r.y=linear_to_gamma(r.y),r.z=linear_to_gamma(r.z)),e.userdata.imageData.setPixelAt({r:r.x,g:r.y,b:r.z,a:1},t,i)}if(++e.userdata.row,yieldFrame(e)){if(update(e,e.userdata.row/this.#image_height))return this.settings.realtimeUpdate&&e.userdata.surface.unlock(e.userdata.imageData),void setTimeout(()=>{this.renderNext(a,e)},0);break}}endFrame(e),e.userdata.surface.unlock(e.userdata.imageData),end(e)}#cacheRay=new ray;#get_ray(e,t){var a=this.#sample_square(),i=new vec3(this.pixel00_loc),r=new vec3(this.pixel_delta_u),e=(r.mul(e+a.x),new vec3(this.pixel_delta_v));return e.mul(t+a.y),i.add(r),i.add(e),this.#cacheRay.origin_.x=this.camera_center.x,this.#cacheRay.origin_.y=this.camera_center.y,this.#cacheRay.origin_.z=this.camera_center.z,this.#cacheRay.direction_.x=i.x-this.camera_center.x,this.#cacheRay.direction_.y=i.y-this.camera_center.y,this.#cacheRay.direction_.z=i.z-this.camera_center.z,this.#cacheRay}#sample_square(){return new vec3(sgxRand()-.5,sgxRand()-.5,0)}#rcShadedWorld(e,t,a){if(t<0)return kBlack$1;var i=this.settings.fixShadowAcne?.001:0,i=new interval(i,SGX_INF),i=a.hitInterval(e,i);if(i){if(i.normal(),i.material){i=i.material.scatter(e,i);if(i)return(t=this.#rcShadedWorld(i.scattered,t-1,a)).x*=i.attenuation.x,t.y*=i.attenuation.y,t.z*=i.attenuation.z,t}return new color3(kBlack$1)}return rcGradient(e)}logRender(){console.log(`Last render frame took ${this.lastFrameRenderMilliseconds} milliseconds`)}};var s10=Object.freeze({__proto__:null,Camera:Camera$1,CameraSettings:CameraSettings$1});let kBlack=new color3(0,0,0);class CameraSettings{constructor(){this.scatteringMaxDepth=10,this.fixShadowAcne=!0,this.applyGammaCorrection=!0,this.applyDefocus=!1,this.realtimeUpdate=!0}}class Camera{#surface;#image_width;#image_height;#aspect_ratio;#samples_per_pixel;#pixel_samples_scale;#u;#v;#w;#defocus_disk_u;#defocus_disk_v;constructor(e){this.#surface=e,this.#image_width=e.getWidth(),this.#image_height=e.getHeight(),this.#aspect_ratio=this.#image_width/this.#image_height,this.initialise()}initialise(){this.lookfrom=new point3(0,0,0),this.lookat=new point3(0,0,-1),this.vup=new vec3(0,1,0),this.fov=90,this.defocus_angle=0,this.focus_dist=10,this.#u=new point3(0,0,0),this.#v=new point3(0,0,0),this.#w=new point3(0,0,0),this.setSamplesPerPixel(10),this.settings=new CameraSettings}#recomputeCamera(){this.camera_center=new point3(this.lookfrom);var e=new point3(this.lookfrom);e.sub(this.lookat);let t=sgxSqr(e.getMagnitudeSquared());this.settings.applyDefocus&&(t=this.focus_dist);var e=sgxToRadians(this.fov),e=2*sgxTan(e/2)*t,a=e*(this.#image_width/this.#image_height),i=(this.#w.set(this.lookfrom),this.#w.sub(this.lookat),this.#w.normalize(),this.#u=this.vup.cross(this.#w),this.#u.normalize(),this.#v=this.#w.cross(this.#u),new vec3(this.#u)),a=(i.mul(a),new vec3(this.#v)),e=(a.mul(-e),this.pixel_delta_u=new vec3(i),this.pixel_delta_u.div(this.#image_width),this.pixel_delta_v=new vec3(a),this.pixel_delta_v.div(this.#image_height),new vec3(i)),i=(e.div(2),new vec3(a)),a=(i.div(2),new vec3(this.#w)),e=(a.mul(t),a.neg(),a.add(this.camera_center),a.sub(e),a.sub(i),new vec3(this.pixel_delta_u)),i=(e.add(this.pixel_delta_v),e.mul(.5),this.pixel00_loc=new vec3(a),this.pixel00_loc.add(e),this.focus_dist*sgxTan(sgxToRadians(this.defocus_angle/2)));this.#defocus_disk_u=new vec3(this.#u),this.#defocus_disk_u.mul(i),this.#defocus_disk_v=new vec3(this.#v),this.#defocus_disk_v.mul(i)}setSamplesPerPixel(e){this.#samples_per_pixel=e,this.#pixel_samples_scale=1/e}getSamplesPerPixel(){return this.#samples_per_pixel}render(e){var t=start(),a=new sgx.ImageData;this.#surface.lock(a),this.#recomputeCamera(),t.userdata={row:0,surface:this.#surface,imageData:a},this.renderNext(e,t)}renderNext(a,e){for(startFrame(e);e.userdata.row<this.#image_height;){HitRecord.startRay();var i=e.userdata.row;for(let t=0;t<this.#image_width;t++){var r=new color3(0,0,0);for(let e=0;e<this.#samples_per_pixel;e++){var s=this.#get_ray(t,i);r.add(this.#rcShadedWorld(s,this.settings.scatteringMaxDepth,a))}r.mul(this.#pixel_samples_scale),this.settings.applyGammaCorrection&&(r.x=linear_to_gamma(r.x),r.y=linear_to_gamma(r.y),r.z=linear_to_gamma(r.z)),e.userdata.imageData.setPixelAt({r:r.x,g:r.y,b:r.z,a:1},t,i)}if(++e.userdata.row,yieldFrame(e)){if(update(e,e.userdata.row/this.#image_height))return this.settings.realtimeUpdate&&e.userdata.surface.unlock(e.userdata.imageData),void setTimeout(()=>{this.renderNext(a,e)},0);break}}endFrame(e),e.userdata.surface.unlock(e.userdata.imageData),end(e)}#cacheRay=new ray;#get_ray(e,t){var a=new vec3(this.pixel00_loc),i=new vec3(this.pixel_delta_u),e=(i.mul(e+sgxRand()-.5),new vec3(this.pixel_delta_v));e.mul(t+sgxRand()-.5),a.add(i),a.add(e);let r=this.camera_center;return this.settings.applyDefocus&&this.defocus_angle&&(r=this.#defocus_disk_sample()),this.#cacheRay.origin_.x=r.x,this.#cacheRay.origin_.y=r.y,this.#cacheRay.origin_.z=r.z,this.#cacheRay.direction_.x=a.x-r.x,this.#cacheRay.direction_.y=a.y-r.y,this.#cacheRay.direction_.z=a.z-r.z,this.#cacheRay}#defocus_disk_sample(){var e=sgxPoint3f.randomUnitDisk();return e.x*=this.#defocus_disk_u.x,e.y*=this.#defocus_disk_v.y,e.add(this.camera_center),e}#sample_square(){return new vec3(sgxRand()-.5,sgxRand()-.5,0)}#rcShadedWorld(e,t,a){if(t<0)return kBlack;var i=this.settings.fixShadowAcne?.001:0,i=new interval(i,SGX_INF),i=a.hitInterval(e,i);if(i){if(i.normal(),i.material){i=i.material.scatter(e,i);if(i)return(t=this.#rcShadedWorld(i.scattered,t-1,a)).x*=i.attenuation.x,t.y*=i.attenuation.y,t.z*=i.attenuation.z,t}return new color3(kBlack)}return rcGradient(e)}logRender(){console.log(`Last render frame took ${this.lastFrameRenderMilliseconds} milliseconds`)}}var s12=Object.freeze({__proto__:null,Camera:Camera,CameraSettings:CameraSettings});let raytracer$1={ppm:ppm,utils:utils,vec3:vec3,point3:point3,color3:color3,materials:materials,hittable:hittable,surfaces:{Sphere:Sphere},s02:s02,s04:s04,s05:s05,s06:s06,s07:s07,s08:s08,s10:s10,s12:s12};export{raytracer$1 as raytracer};